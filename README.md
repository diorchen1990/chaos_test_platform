# ChaosBlade æ··æ²Œæµ‹è¯•å¹³å°

åŸºäº ChaosBlade çš„åˆ†å¸ƒå¼æ··æ²Œå·¥ç¨‹æµ‹è¯•å¹³å°ï¼Œæä¾›å¯è§†åŒ–ç•Œé¢æ¥ç®¡ç†å’Œæ‰§è¡Œæ··æ²Œå®éªŒã€‚

## ç›®å½•
- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [å®‰è£…éƒ¨ç½²](#å®‰è£…éƒ¨ç½²)
  - [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
  - [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
  - [æ‰‹åŠ¨éƒ¨ç½²](#æ‰‹åŠ¨éƒ¨ç½²)
  - [éªŒè¯éƒ¨ç½²](#éªŒè¯éƒ¨ç½²)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
  - [æ ¸å¿ƒé…ç½®](#æ ¸å¿ƒé…ç½®)
  - [ç¯å¢ƒå˜é‡](#ç¯å¢ƒå˜é‡)
  - [æƒé™è¦æ±‚](#æƒé™è¦æ±‚)
- [æ¢é’ˆç®¡ç†](#æ¢é’ˆç®¡ç†)
  - [å®‰è£…æ–¹å¼](#å®‰è£…æ–¹å¼)
  - [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
  - [éªŒè¯å®‰è£…](#éªŒè¯å®‰è£…)
- [ChaosBlade](#chaosblade)
  - [å®‰è£…é…ç½®](#å®‰è£…é…ç½®)
  - [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
  - [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

> **é‡è¦æç¤ºï¼š**
> 1. åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼Œè¯·ç¡®ä¿å®Œæ•´é˜…è¯»é…ç½®è¯´æ˜å’Œæ³¨æ„äº‹é¡¹
> 2. å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œå……åˆ†éªŒè¯
> 3. è¯·å¦¥å–„ä¿ç®¡å„ç±»å¯†é’¥å’Œå¯†ç ä¿¡æ¯

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- ğŸŒ åˆ†å¸ƒå¼ç³»ç»Ÿæ•…éšœæ³¨å…¥
- ğŸ“Š å¯è§†åŒ–å®éªŒç®¡ç†
- ğŸ” å…¨æ–¹ä½ç›‘æ§èƒ½åŠ›
- ğŸ“ ç”¨ä¾‹ç®¡ç†ä¸å¤ç”¨
- ğŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½²æ”¯æŒ

### æ•…éšœç±»å‹æ”¯æŒ
- **Javaåº”ç”¨æ•…éšœ**
  - æ–¹æ³•å»¶è¿Ÿæ³¨å…¥
  - å¼‚å¸¸æ³¨å…¥
  - çº¿ç¨‹æ± æ•…éšœ
  - GCå‹åŠ›æ¨¡æ‹Ÿ
  - å†…å­˜æ³„æ¼æ¨¡æ‹Ÿ

- **æ•°æ®åº“æ•…éšœ**
  - è¿æ¥è¶…æ—¶
  - æ…¢æŸ¥è¯¢æ¨¡æ‹Ÿ
  - è¿æ¥æ± æ»¡è½½
  - SQLæ‰§è¡Œå¼‚å¸¸

- **åˆ†å¸ƒå¼æ•…éšœ**
  - æœåŠ¡è°ƒç”¨å»¶è¿Ÿ
  - ç½‘ç»œåˆ†åŒºæ¨¡æ‹Ÿ
  - æ¶ˆæ¯å»¶è¿ŸæŠ•é€’
  - RPCè°ƒç”¨å¼‚å¸¸

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
```bash
# å¿…éœ€ç»„ä»¶
- Docker 20.10+
- Docker Compose 2.0+
- MySQL 8.0+
- Prometheus 2.30+
- Grafana 8.0+

# ç³»ç»Ÿè¦æ±‚
- CPU: 4æ ¸+
- å†…å­˜: 8GB+
- ç£ç›˜: 50GB+
- æ“ä½œç³»ç»Ÿ: Linux (CentOS 7+/Ubuntu 18.04+)
```
### å®‰è£…å‰å‡†å¤‡
```bash
# 1. ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥
df -h
free -h
nproc

# 2. å®‰è£…ä¾èµ–
# CentOS
yum install -y wget curl git docker

# Ubuntu
apt-get update
apt-get install -y wget curl git docker.io

# 3. é…ç½®Docker
systemctl enable docker
systemctl start docker
```

### å¿«é€Ÿéƒ¨ç½²
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/diorchen1990/chaos_test_platform
cd chaos-platform

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. éªŒè¯éƒ¨ç½²
curl http://localhost:8080/api/health
```

## ç³»ç»Ÿæ¶æ„

### ç»„ä»¶è¯´æ˜
1. **æ§åˆ¶å¹³å°**
   - Webç•Œé¢ï¼šå®éªŒç®¡ç†ã€ç›‘æ§å±•ç¤º
   - APIæœåŠ¡ï¼šæä¾›RESTfulæ¥å£
   - è°ƒåº¦ç³»ç»Ÿï¼šå®éªŒç¼–æ’å’Œæ‰§è¡Œ
   - ç›‘æ§ç³»ç»Ÿï¼šæŒ‡æ ‡é‡‡é›†å’Œå±•ç¤º

2. **Agentç»„ä»¶**
   - æ•…éšœæ³¨å…¥æ‰§è¡Œå™¨
   - æŒ‡æ ‡é‡‡é›†å™¨
   - çŠ¶æ€ç®¡ç†å™¨

3. **å­˜å‚¨ç³»ç»Ÿ**
   - MySQLï¼šå…ƒæ•°æ®å­˜å‚¨
   - Prometheusï¼šç›‘æ§æ•°æ®
   - Elasticsearchï¼šæ—¥å¿—å­˜å‚¨

## é…ç½®è¯´æ˜

### æ ¸å¿ƒé…ç½®æ–‡ä»¶
```yaml
# backend/config/config.yaml
server:
  port: 8080
  host: 0.0.0.0
  debug: false

database:
  driver: mysql
  host: localhost
  port: 3306
  username: your_username
  password: your_password

chaosblade:
  path: /usr/local/bin/blade
  prepare:
    jvm: true
    docker: true
    kubernetes: false
```

### ç¯å¢ƒå˜é‡
```bash
# å¿…éœ€çš„ç¯å¢ƒå˜é‡
MYSQL_ROOT_PASSWORD=xxx     # MySQL rootå¯†ç 
MYSQL_DATABASE=chaos        # æ•°æ®åº“å
DB_USER=xxx                # æ•°æ®åº“ç”¨æˆ·
DB_PASSWORD=xxx            # æ•°æ®åº“å¯†ç 

# å¯é€‰çš„ç¯å¢ƒå˜é‡
LOG_LEVEL=info             # æ—¥å¿—çº§åˆ«
PROMETHEUS_URL=xxx         # Prometheusåœ°å€
```
## è‡ªå®šä¹‰é…ç½®è¯´æ˜

### 1. é¡¹ç›®é…ç½®æ›¿æ¢

#### 1.1 åŒ…å¯¼å…¥è·¯å¾„
åœ¨æ‰€æœ‰ Go æ–‡ä»¶ä¸­éœ€è¦æ›¿æ¢åŒ…å¯¼å…¥è·¯å¾„ï¼š

```go
// æ›¿æ¢å‰
import (
    "your-project/models"
    "your-project/services"
    "your-project/pkg/errors"
)

// æ›¿æ¢å
import (
    "github.com/chaos-mesh/chaos-platform/models"
    "github.com/chaos-mesh/chaos-platform/services"
    "github.com/chaos-mesh/chaos-platform/pkg/errors"
)
```

#### 1.2 Dockeré•œåƒ
åœ¨ docker-compose.yml ä¸­æ›¿æ¢é•œåƒåç§°ï¼š

```yaml
services:
  backend:
    image: <your-registry>/chaos-platform-backend:latest  # æ›¿æ¢ä¸ºå®é™…çš„é•œåƒä»“åº“åœ°å€
  frontend:
    image: <your-registry>/chaos-platform-frontend:latest # æ›¿æ¢ä¸ºå®é™…çš„é•œåƒä»“åº“åœ°å€
```

#### 1.3 æœåŠ¡åœ°å€
åœ¨é…ç½®æ–‡ä»¶ä¸­æ›¿æ¢æœåŠ¡åœ°å€ï¼š

```yaml
# backend/config/config.yaml
server:
  host: <your-host>          # æ›¿æ¢ä¸ºå®é™…çš„æœåŠ¡å™¨åœ°å€
  port: 8080

monitor:
  prometheus:
    url: <prometheus-url>    # æ›¿æ¢ä¸ºå®é™…çš„Prometheusåœ°å€
  grafana:
    url: <grafana-url>       # æ›¿æ¢ä¸ºå®é™…çš„Grafanaåœ°å€

alert:
  dingtalk:
    webhook: <webhook-url>   # æ›¿æ¢ä¸ºå®é™…çš„é’‰é’‰webhookåœ°å€
```

### 2. è‡ªå®šä¹‰å¼€å‘

#### 2.1 æ•…éšœç±»å‹
åœ¨ `backend/models/experiment.go` ä¸­æ·»åŠ æ–°çš„æ•…éšœç±»å‹ï¼š

```go
// æ·»åŠ è‡ªå®šä¹‰æ•…éšœç±»å‹
const (
    // Javaåº”ç”¨æ•…éšœ
    ActionJavaException   = "java-exception"
    ActionJavaLatency    = "java-latency"
    ActionJavaOOM        = "java-oom"
    
    // æ•°æ®åº“æ•…éšœ
    ActionDBTimeout      = "db-timeout"
    ActionDBError       = "db-error"
    
    // è‡ªå®šä¹‰æ•…éšœç±»å‹
    ActionCustomFault    = "custom-fault"
)

// å®ç°æ•…éšœå¤„ç†å™¨
func (h *ExperimentHandler) handleCustomFault(ctx context.Context, exp *models.Experiment) error {
    // å®ç°è‡ªå®šä¹‰æ•…éšœæ³¨å…¥é€»è¾‘
    return nil
}
```

#### 2.2 ç›‘æ§æŒ‡æ ‡
åœ¨ `backend/core/monitor/metrics.go` ä¸­æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡ï¼š

```go
var (
    // å®éªŒç›¸å…³æŒ‡æ ‡
    experimentExecutions = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "chaos_experiment_executions_total",
            Help: "Total number of chaos experiments executed",
        },
        []string{"type", "status"},
    )

    // è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
    customMetrics = prometheus.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "chaos_custom_metric",
            Help: "Custom business metrics",
        },
        []string{"service", "method"},
    )
)

func init() {
    // æ³¨å†ŒæŒ‡æ ‡
    prometheus.MustRegister(experimentExecutions)
    prometheus.MustRegister(customMetrics)
}
```

#### 2.3 æ¢é’ˆå®ç°
åœ¨ `agent/probe/custom_probe.go` ä¸­å®ç°è‡ªå®šä¹‰æ¢é’ˆï¼š

```go
type CustomProbe struct {
    config ProbeConfig
    logger *zap.Logger
}

func (p *CustomProbe) Init(config ProbeConfig) error {
    p.config = config
    return nil
}

func (p *CustomProbe) InjectFault(fault Fault) error {
    // å®ç°æ•…éšœæ³¨å…¥é€»è¾‘
    switch fault.Type {
    case "custom-fault":
        return p.injectCustomFault(fault)
    default:
        return errors.New("unsupported fault type")
    }
}

func (p *CustomProbe) injectCustomFault(fault Fault) error {
    // å®ç°è‡ªå®šä¹‰æ•…éšœæ³¨å…¥
    return nil
}
```

### 3. é…ç½®é¡¹è¯´æ˜

#### 3.1 å®éªŒé…ç½®
```yaml
experiment:
  timeout: 300              # å®éªŒè¶…æ—¶æ—¶é—´(ç§’)
  concurrent: 10            # æœ€å¤§å¹¶å‘æ•°
  retries: 3               # é‡è¯•æ¬¡æ•°
  workDir: /opt/chaos/experiments  # å·¥ä½œç›®å½•

recovery:
  auto: true               # æ˜¯å¦è‡ªåŠ¨æ¢å¤
  timeout: 60              # æ¢å¤è¶…æ—¶æ—¶é—´(ç§’)
  retries: 3               # æ¢å¤é‡è¯•æ¬¡æ•°
```

#### 3.2 ç›‘æ§é…ç½®
```yaml
monitor:
  prometheus:
    scrapeInterval: 15s    # é‡‡é›†é—´éš”
    retentionTime: 15d     # æ•°æ®ä¿ç•™æ—¶é—´
  grafana:
    dashboardDir: /opt/chaos/dashboards  # é¢æ¿ç›®å½•
```

#### 3.3 å‘Šè­¦é…ç½®
```yaml
alert:
  enable: true
  providers:
    - type: email
      host: smtp.example.com
      port: 587
      username: your-email
      password: your-password
    - type: dingtalk
      webhook: https://oapi.dingtalk.com/robot/send?access_token=xxx
```

### 4. æ³¨æ„äº‹é¡¹

1. æƒé™æ§åˆ¶
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨è®¤è¯
   - å®éªŒæ‰§è¡Œéœ€è¦å®¡æ‰¹
   - å…³é”®æ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤

2. æ•°æ®å®‰å…¨
   - å®šæœŸå¤‡ä»½å®éªŒæ•°æ®
   - åŠ å¯†æ•æ„Ÿé…ç½®ä¿¡æ¯
   - ä¿ç•™æ“ä½œå®¡è®¡æ—¥å¿—

3. ç›‘æ§å‘Šè­¦
   - é…ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
   - è®¾ç½®å‘Šè­¦å‡çº§ç­–ç•¥
   - ç¡®ä¿å‘Šè­¦åŠæ—¶é€è¾¾

4. æ•…éšœæ¢å¤
   - éªŒè¯æ¢å¤æœºåˆ¶å¯ç”¨æ€§
   - å‡†å¤‡æ‰‹åŠ¨æ¢å¤æ–¹æ¡ˆ
   - è®°å½•æ¢å¤æ“ä½œæ­¥éª¤
## æ•…éšœæ’æŸ¥æŒ‡å—

### 1. æœåŠ¡å¯åŠ¨é—®é¢˜
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs -f backend
docker-compose logs -f frontend

# æ£€æŸ¥é…ç½®
cat config/config.yaml
```

### 2. Agentè¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥AgentçŠ¶æ€
curl http://localhost:8080/api/agents/status

# æŸ¥çœ‹Agentæ—¥å¿—
tail -f /var/log/chaos-agent.log
```

### 3. å®éªŒæ‰§è¡Œé—®é¢˜
```bash
# æ£€æŸ¥å®éªŒçŠ¶æ€
curl http://localhost:8080/api/experiments/{id}

# æŸ¥çœ‹ChaosBladeæ—¥å¿—
blade status
```

## å®‰å…¨å»ºè®®

### 1. è®¿é—®æ§åˆ¶
- ä½¿ç”¨å¼ºå¯†ç å’Œå¯†é’¥
- å¯ç”¨HTTPS
- é…ç½®é˜²ç«å¢™è§„åˆ™
- å®æ–½IPç™½åå•

### 2. æ•°æ®å®‰å…¨
- å®šæœŸå¤‡ä»½æ•°æ®
- åŠ å¯†æ•æ„Ÿä¿¡æ¯
- å®æ–½å®¡è®¡æ—¥å¿—
- ç›‘æ§å¼‚å¸¸è®¿é—®

## ç»´æŠ¤æŒ‡å—

### 1. æ—¥å¸¸ç»´æŠ¤
```bash
# æ¸…ç†æ—¥å¿—
find /var/log/chaos-platform -name "*.log" -mtime +30 -delete

# å¤‡ä»½æ•°æ®
mysqldump -u root -p chaos_platform > backup.sql

# æ›´æ–°ç³»ç»Ÿ
docker-compose pull
docker-compose up -d
```

### 2. ç›‘æ§æ£€æŸ¥
- å®šæœŸæ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
- ç›‘æ§æœåŠ¡è¿è¡ŒçŠ¶æ€
- æ£€æŸ¥æ—¥å¿—æ˜¯å¦æ­£å¸¸è½®è½¬
- éªŒè¯å¤‡ä»½æ˜¯å¦å¯ç”¨

## å¼€å‘æŒ‡å—

1. åç«¯å¼€å‘
```bash
# å®‰è£…ä¾èµ–
make setup

# ç”Ÿæˆä»£ç 
make generate

# è¿è¡Œæµ‹è¯•
make test
```

### 2. æœ¬åœ°å¼€å‘
```bash
# å¯åŠ¨åç«¯æœåŠ¡
make run

# å¯åŠ¨å‰ç«¯æœåŠ¡
cd web && npm run serve
```

### 3. æ„å»ºéƒ¨ç½²
```bash
# æ„å»ºäºŒè¿›åˆ¶
make build

# æ„å»ºDockeré•œåƒ
make docker

# éƒ¨ç½²æœåŠ¡
docker-compose up -d
```

### 4. ä»£ç è§„èŒƒ
- éµå¾ª [Go ä»£ç è§„èŒƒ](https://golang.org/doc/effective_go)
- ä½¿ç”¨ `gofmt` æ ¼å¼åŒ–ä»£ç 
- è¿è¡Œ `golangci-lint` æ£€æŸ¥ä»£ç è´¨é‡
```

## ç»´æŠ¤è€…

- ç»´æŠ¤è€…ï¼š[å§“å]
- é‚®ç®±ï¼š[é‚®ç®±]

## å¼€æºåè®®

MIT License
